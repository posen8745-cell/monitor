<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>順向坡位移警示（雨量 Mock / CWA API）</title>
  <style>
    :root{
      --bg:#0b1220; --card:#121a2b; --text:#e6eefc; --muted:#a9b7d3; --line:#26314a;
      --btn:#2a66ff; --danger:#ff4d4f; --warn:#ffb020; --ok:#22c55e; --info:#60a5fa;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1220 0%,#070c16 100%);color:var(--text);
      font-family:system-ui,-apple-system,"Segoe UI","Noto Sans TC","Microsoft JhengHei",Arial}
    header{padding:20px 16px 10px;max-width:1100px;margin:0 auto}
    h1{margin:0 0 6px;font-size:20px}
    .sub{color:var(--muted);font-size:13px;line-height:1.5}
    main{max-width:1100px;margin:0 auto;padding:12px 16px 28px;display:grid;grid-template-columns:380px 1fr;gap:14px}
    @media (max-width:980px){main{grid-template-columns:1fr}}
    .card{background:rgba(18,26,43,.92);border:1px solid rgba(38,49,74,.9);border-radius:14px;padding:14px}
    .row{display:flex;gap:10px;align-items:center}
    .row>*{flex:1}
    label{display:block;color:var(--muted);font-size:12px;margin:10px 0 6px}
    input,select{width:100%;background:#0c1324;border:1px solid #24314c;color:var(--text);
      border-radius:10px;padding:10px;font-size:14px}
    button{background:var(--btn);border:none;color:white;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:700}
    button.secondary{background:#273451}
    button.danger{background:var(--danger)}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;
      border:1px solid #2b395a;background:#0c1324;color:var(--muted);font-size:12px}
    .statusDot{width:10px;height:10px;border-radius:50%}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .kpi{border:1px solid #23304b;border-radius:12px;padding:12px;background:#0c1324}
    .kpi .t{color:var(--muted);font-size:12px}
    .kpi .v{font-size:22px;font-weight:800;margin-top:6px}
    .mono{font-family:ui-monospace,Consolas,monospace}
    .hr{height:1px;background:rgba(38,49,74,.9);margin:12px 0}
    canvas{width:100%;height:220px;background:#0c1324;border:1px solid #23304b;border-radius:12px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid rgba(38,49,74,.6);padding:8px;font-size:13px}
    th{color:var(--muted)}
    .right{text-align:right}
    .switch{display:flex;gap:10px;align-items:center;border:1px solid #2b395a;background:#0c1324;border-radius:12px;padding:10px}
  </style>
</head>
<body>

<header>
  <h1>順向坡位移警示（雨量監測）</h1>
  <div class="sub">
    GitHub Pages 示範版（方案 A）：預設使用 <span class="mono">mock_cwa.json</span> 模擬雨量，
    計算 1h / 24h / 72h 與 AER（有效累積雨量），觸發警戒分級。
  </div>
</header>

<main>
  <section class="card">
    <div class="row">
      <div class="pill"><span class="statusDot" id="sysDot" style="background:var(--info)"></span><span id="sysText">尚未開始</span></div>
      <div class="pill mono">localStorage</div>
    </div>

    <label>模式</label>
    <div class="switch">
      <input type="checkbox" id="useMock" checked />
      <div>
        <div style="font-weight:700">使用 Mock（免 API Key）</div>
        <div class="sub">從 <span class="mono">./mock_cwa.json</span> 讀資料</div>
      </div>
    </div>

    <label>StationId（雨量站代碼）</label>
    <input id="stationId" value="C0A9F0"/>

    <label>輪詢頻率</label>
    <select id="pollSec">
      <option value="60">每 60 秒</option>
      <option value="300">每 5 分鐘</option>
      <option value="600" selected>每 10 分鐘</option>
    </select>

    <div class="hr"></div>
    <div class="row">
      <button id="btnStart">開始監測</button>
      <button class="secondary" id="btnStop">停止</button>
      <button class="danger" id="btnClear">清除本機歷史</button>
    </div>
  </section>

  <section class="card">
    <div class="row">
      <div class="pill"><span class="statusDot" id="riskDot" style="background:var(--info)"></span><span id="riskText">—</span></div>
      <div class="pill">Rainfall → Risk</div>
    </div>

    <div class="grid3" style="margin-top:10px">
      <div class="kpi"><div class="t">10min</div><div class="v"><span id="k10">—</span> mm</div></div>
      <div class="kpi"><div class="t">24h</div><div class="v"><span id="k24">—</span> mm</div></div>
      <div class="kpi"><div class="t">72h</div><div class="v"><span id="k72">—</span> mm</div></div>
    </div>

    <div class="hr"></div>
    <canvas id="chart" width="1200" height="260"></canvas>

    <div class="hr"></div>
    <table>
      <thead><tr><th>時間</th><th class="right">10min</th></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </section>
</main>

<script>
const $=id=>document.getElementById(id);
const now=()=>Date.now();
let timer=null, hist=JSON.parse(localStorage.getItem("hist")||"[]");

function setSys(t,c){$("sysText").textContent=t;$("sysDot").style.background=`var(${c})`}
function setRisk(t,c){$("riskText").textContent=t;$("riskDot").style.background=`var(${c})`}

async function fetchStations(){
  const r=await fetch("./mock_cwa.json",{cache:"no-store"});
  const j=await r.json();
  return j.records.Station;
}

function sum(ms){
  const t0=now()-ms;return hist.filter(x=>x.ts>=t0).reduce((a,b)=>a+b.p10,0);
}

function render(){
  $("k10").textContent=(hist.at(-1)?.p10??"—");
  $("k24").textContent=sum(24*3600*1000).toFixed(1);
  $("k72").textContent=sum(72*3600*1000).toFixed(1);
  const tr=hist.slice(-12).reverse().map(x=>`<tr><td class="mono">${new Date(x.ts).toLocaleString()}</td><td class="right mono">${x.p10}</td></tr>`).join("");
  $("tbody").innerHTML=tr;
  setRisk(sum(24*3600*1000)>=150?"橘色（警戒）":"綠色（正常）", sum(24*3600*1000)>=150?"--warn":"--ok");
}

async function tick(){
  setSys("抓取中…","--info");
  const st=(await fetchStations()).find(x=>x.StationId===$("stationId").value);
  let p10=Number(st.RainfallElement.Now.Precipitation)||0;
  p10=Math.round((p10+(Math.random()<0.08?10:Math.random()*3))*10)/10;
  hist.push({ts:now(),p10}); hist=hist.slice(-500);
  localStorage.setItem("hist",JSON.stringify(hist));
  render(); setSys("監測中","--ok");
}

$("btnStart").onclick=()=>{if(timer)clearInterval(timer);tick();timer=setInterval(tick,Number($("pollSec").value)*1000)};
$("btnStop").onclick=()=>{if(timer)clearInterval(timer);setSys("已停止","--warn")};
$("btnClear").onclick=()=>{hist=[];localStorage.removeItem("hist");render();setSys("已清除","--warn")};

render(); setSys("尚未開始","--info");
</script>
</body>
</html>
