<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>é †å‘å¡ä½ç§»è­¦ç¤ºï¼ˆé›¨é‡ Mock / CWA APIï¼‰</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#121a2b;
      --text:#e6eefc;
      --muted:#a9b7d3;
      --line:#26314a;
      --btn:#2a66ff;
      --danger:#ff4d4f;
      --warn:#ffb020;
      --ok:#22c55e;
      --info:#60a5fa;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:linear-gradient(180deg, #0b1220 0%, #070c16 100%);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Noto Sans TC", "Microsoft JhengHei", Arial;
    }
    header{
      padding:20px 16px 10px;
      max-width:1100px;
      margin:0 auto;
    }
    h1{margin:0 0 6px;font-size:20px;letter-spacing:.5px}
    .sub{color:var(--muted);font-size:13px;line-height:1.5}
    main{
      max-width:1100px;
      margin:0 auto;
      padding:12px 16px 28px;
      display:grid;
      grid-template-columns: 380px 1fr;
      gap:14px;
    }
    @media (max-width:980px){ main{grid-template-columns:1fr} }
    .card{
      background:rgba(18,26,43,.92);
      border:1px solid rgba(38,49,74,.9);
      border-radius:14px;
      padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .row{display:flex;gap:10px;align-items:center}
    .row > *{flex:1}
    label{display:block;color:var(--muted);font-size:12px;margin:10px 0 6px}
    input, select, textarea{
      width:100%;
      background:#0c1324;
      border:1px solid #24314c;
      color:var(--text);
      border-radius:10px;
      padding:10px 10px;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:64px;resize:vertical}
    input:focus, textarea:focus, select:focus{border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.15)}
    button{
      background:var(--btn);
      border:none;
      color:white;
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
      letter-spacing:.3px;
    }
    button.secondary{background:#273451}
    button.danger{background:var(--danger)}
    button:disabled{opacity:.55;cursor:not-allowed}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #2b395a;
      background:#0c1324;
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .statusDot{width:10px;height:10px;border-radius:50%}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .kpi{
      border:1px solid #23304b;
      border-radius:12px;
      padding:12px;
      background:#0c1324;
    }
    .kpi .t{color:var(--muted);font-size:12px}
    .kpi .v{font-size:22px;font-weight:800;margin-top:6px}
    .kpi .u{color:var(--muted);font-size:12px;margin-left:6px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .small{font-size:12px;color:var(--muted);line-height:1.45}
    .hr{height:1px;background:rgba(38,49,74,.9);margin:12px 0}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid rgba(38,49,74,.6);padding:10px 8px;text-align:left;font-size:13px}
    th{color:var(--muted);font-weight:600}
    .right{text-align:right}
    canvas{width:100%;height:220px;background:#0c1324;border:1px solid #23304b;border-radius:12px}
    .toast{
      position:fixed;right:14px;bottom:14px;max-width:360px;
      background:#0c1324;border:1px solid #23304b;border-radius:12px;padding:12px;
      box-shadow:0 12px 30px rgba(0,0,0,.35);display:none;
    }
    .toast .title{font-weight:800;margin-bottom:6px}
    .toast .msg{color:var(--muted);font-size:13px;line-height:1.45}
    .switch{
      display:flex;align-items:center;gap:10px;
      border:1px solid #2b395a;background:#0c1324;border-radius:12px;
      padding:10px;
    }
    .switch input{width:auto;transform:scale(1.1)}
  </style>
</head>

<body>
<header>
  <h1>é †å‘å¡ä½ç§»è­¦ç¤ºï¼ˆé›¨é‡ï¼šMock / ä¸­å¤®æ°£è±¡ç½² APIï¼‰</h1>
  <div class="sub">
    âœ… GitHub Pages æ–¹æ¡ˆ Aï¼šä½¿ç”¨åŒç›®éŒ„ <span class="mono">mock_cwa.json</span> ä¾†æ¨¡æ“¬é›¨é‡ APIã€‚<br/>
    ï¼ˆå¦‚è¦æ”¹æˆçœŸ APIï¼Œåªè¦é—œé–‰ Mockï¼Œä¸¦å¡«å…¥ä½ çš„ Authorization å³å¯ï¼‰
  </div>
</header>

<main>
  <!-- LEFT: Controls -->
  <section class="card">
    <div class="row" style="justify-content:space-between;gap:10px;align-items:flex-start">
      <div class="pill" id="sysStatus">
        <span class="statusDot" id="sysDot" style="background:var(--info)"></span>
        <span id="sysText">å°šæœªé–‹å§‹</span>
      </div>
      <div class="pill mono" title="æœ¬é åªåœ¨ä½ çš„ç€è¦½å™¨ä¿å­˜è¨­å®šèˆ‡é›¨é‡æ­·å²ï¼ˆlocalStorageï¼‰">
        localStorage
      </div>
    </div>

    <label>æ¨¡å¼</label>
    <div class="switch">
      <input type="checkbox" id="useMock" />
      <div style="flex:1">
        <div style="font-weight:800">ä½¿ç”¨ Mockï¼ˆGitHub Pages æ¨è–¦ï¼‰</div>
        <div class="small">é–‹å•Ÿï¼šå¾ <span class="mono">./mock_cwa.json</span> è®€è³‡æ–™ï¼ˆä¸éœ€è¦ API Keyï¼‰</div>
      </div>
    </div>

    <label>ä¸­å¤®æ°£è±¡ç½² API Keyï¼ˆAuthorizationï¼‰</label>
    <input id="apiKey" placeholder="çœŸ API æ‰éœ€è¦ï¼›Mock å¯ç•™ç©º" />

    <label>æ¸¬ç«™ StationIdï¼ˆé›¨é‡ç«™ä»£ç¢¼ï¼‰</label>
    <div class="row">
      <input id="stationId" placeholder="ä¾‹å¦‚ï¼šC0A9F0ï¼ˆmock å…§æœ‰ï¼‰" />
      <button class="secondary" id="btnTest">æ¸¬è©¦æŠ“å–</button>
    </div>

    <div class="hr"></div>

    <label>è³‡æ–™æ“·å– URLï¼ˆçœŸ API é è¦½ï¼›Mock æœƒé¡¯ç¤º ./mock_cwa.jsonï¼‰</label>
    <input id="apiUrl" class="mono" />

    <label>è¼ªè©¢é »ç‡</label>
    <select id="pollSec">
      <option value="60">æ¯ 60 ç§’ï¼ˆæ¸¬è©¦ç”¨ï¼‰</option>
      <option value="300">æ¯ 5 åˆ†é˜</option>
      <option value="600" selected>æ¯ 10 åˆ†é˜ï¼ˆå»ºè­°ï¼‰</option>
      <option value="1800">æ¯ 30 åˆ†é˜</option>
    </select>

    <div class="hr"></div>

    <label>è­¦æˆ’é–€æª»ï¼ˆmmï¼‰</label>
    <div class="grid2">
      <div>
        <div class="small">é»ƒï¼šR24 â‰¥</div>
        <input id="thY_R24" type="number" step="1" value="80" />
      </div>
      <div>
        <div class="small">æ©˜ï¼šR24 â‰¥</div>
        <input id="thO_R24" type="number" step="1" value="150" />
      </div>
    </div>
    <div class="grid2" style="margin-top:10px">
      <div>
        <div class="small">ç´…ï¼šR24 â‰¥</div>
        <input id="thR_R24" type="number" step="1" value="200" />
      </div>
      <div>
        <div class="small">ç´…ï¼šä¸” R72 â‰¥</div>
        <input id="thR_R72" type="number" step="1" value="300" />
      </div>
    </div>

    <label>æœ‰æ•ˆç´¯ç©é›¨é‡ AERï¼ˆæŒ‡æ•¸è¡°æ¸›ï¼‰</label>
    <div class="grid2">
      <div>
        <div class="small">è¡°æ¸›åŠè¡°æœŸï¼ˆå°æ™‚ï¼‰</div>
        <input id="aerHalfLifeH" type="number" step="1" value="36" />
      </div>
      <div>
        <div class="small">AER é¡å¤–ç´…è‰²é–€æª»ï¼ˆmmï¼Œå¯ç•™ç©ºä¸å•Ÿç”¨ï¼‰</div>
        <input id="thAER_Red" type="number" step="1" placeholder="ä¾‹å¦‚ 260" />
      </div>
    </div>

    <div class="hr"></div>

    <div class="row">
      <button id="btnStart">é–‹å§‹ç›£æ¸¬</button>
      <button class="secondary" id="btnStop" disabled>åœæ­¢</button>
      <button class="danger" id="btnClear">æ¸…é™¤æœ¬æ©Ÿæ­·å²</button>
    </div>

    <div class="small" style="margin-top:10px">
      âœ… é€™é æœƒæŠŠæ¯æ¬¡æŠ“åˆ°çš„ã€Œ10 åˆ†é˜é›¨é‡ã€å­˜åœ¨ç€è¦½å™¨ï¼Œä¸¦è‡ªè¡Œç´¯ç©ç®—å‡º 1h/24h/72h/AERã€‚<br/>
      ğŸ“Œ GitHub Pagesï¼šè«‹æŠŠ <span class="mono">index.html</span> èˆ‡ <span class="mono">mock_cwa.json</span> æ”¾åœ¨åŒä¸€å±¤ã€‚
    </div>
  </section>

  <!-- RIGHT: Dashboard -->
  <section class="card">
    <div class="row" style="justify-content:space-between;gap:10px">
      <div>
        <div class="pill" id="riskPill">
          <span class="statusDot" id="riskDot" style="background:var(--info)"></span>
          <span id="riskText">â€”</span>
        </div>
        <div class="small" style="margin-top:8px">
          æœ€å¾Œæ›´æ–°ï¼š<span class="mono" id="lastTs">â€”</span>ã€€
          æ¸¬ç«™ï¼š<span class="mono" id="stName">â€”</span>ï¼ˆ<span class="mono" id="stId">â€”</span>ï¼‰
        </div>
      </div>
      <div class="pill">
        <span>ä½ç§»è­¦ç¤º</span>
        <span class="mono" style="color:var(--muted)">Rainfall â†’ Risk</span>
      </div>
    </div>

    <div class="hr"></div>

    <div class="grid3">
      <div class="kpi">
        <div class="t">è¿‘ 10 åˆ†é˜é›¨é‡</div>
        <div class="v"><span id="k10">â€”</span><span class="u">mm</span></div>
      </div>
      <div class="kpi">
        <div class="t">è¿‘ 1 å°æ™‚ç´¯ç©</div>
        <div class="v"><span id="k1h">â€”</span><span class="u">mm</span></div>
      </div>
      <div class="kpi">
        <div class="t">è¿‘ 24 å°æ™‚ç´¯ç©</div>
        <div class="v"><span id="k24h">â€”</span><span class="u">mm</span></div>
      </div>
    </div>

    <div class="grid3" style="margin-top:10px">
      <div class="kpi">
        <div class="t">è¿‘ 72 å°æ™‚ç´¯ç©</div>
        <div class="v"><span id="k72h">â€”</span><span class="u">mm</span></div>
      </div>
      <div class="kpi">
        <div class="t">AERï¼ˆæœ‰æ•ˆç´¯ç©é›¨é‡ï¼‰</div>
        <div class="v"><span id="kAER">â€”</span><span class="u">mm</span></div>
      </div>
      <div class="kpi">
        <div class="t">è³‡æ–™é»æ•¸ï¼ˆæœ¬æ©Ÿï¼‰</div>
        <div class="v"><span id="kN">â€”</span><span class="u">ç­†</span></div>
      </div>
    </div>

    <div class="hr"></div>

    <div style="display:flex;gap:10px;align-items:center;justify-content:space-between">
      <div class="small">åœ–è¡¨ï¼šè¿‘ 24 å°æ™‚ï¼ˆæ¯æ¬¡æŠ“å–ä¸€ç­†ï¼‰</div>
      <div class="pill mono" id="debugLine">â€”</div>
    </div>

    <div style="margin-top:10px">
      <canvas id="chart" width="1200" height="260" aria-label="rain chart"></canvas>
    </div>

    <div class="hr"></div>

    <div class="small" style="margin-bottom:8px">è¿‘ 12 ç­†ç´€éŒ„ï¼ˆæœ€æ–°åœ¨ä¸Šï¼‰</div>
    <table>
      <thead>
        <tr>
          <th>æ™‚é–“</th>
          <th class="right">10min(mm)</th>
          <th class="right">1h</th>
          <th class="right">24h</th>
          <th class="right">72h</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </section>
</main>

<div class="toast" id="toast">
  <div class="title" id="toastTitle">è­¦ç¤º</div>
  <div class="msg" id="toastMsg">â€”</div>
  <div style="margin-top:10px;display:flex;justify-content:flex-end;gap:8px">
    <button class="secondary" id="toastClose">é—œé–‰</button>
  </div>
</div>

<script>
/**
 * âœ… GitHub Pages ç‰ˆå®Œæ•´ index.html
 * - Mock æ¨¡å¼ï¼šfetch("./mock_cwa.json")
 * - çœŸ API æ¨¡å¼ï¼šfetch("https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0002-001?Authorization=KEY")
 * - è‡ªå‹•ç´¯ç© 1h/24h/72h + AER + è­¦æˆ’åˆ†ç´š + toast
 */

// ==========================
// Utilities
// ==========================
const $ = (id) => document.getElementById(id);
const fmt = (n, d=1) => (Number.isFinite(n) ? n.toFixed(d) : "â€”");
const nowMs = () => Date.now();

function setSys(status, colorVar){
  $("sysText").textContent = status;
  $("sysDot").style.background = `var(${colorVar})`;
}
function setRisk(text, colorVar){
  $("riskText").textContent = text;
  $("riskDot").style.background = `var(${colorVar})`;
}

function toast(title, msgHtml){
  $("toastTitle").textContent = title;
  $("toastMsg").innerHTML = msgHtml;
  $("toast").style.display = "block";
}
$("toastClose").addEventListener("click", ()=> $("toast").style.display = "none");

// ==========================
// Local storage schema
// ==========================
const LS_KEY = "rain_history_v1";
const LS_CFG = "rain_cfg_v1";

function loadHistory(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return [];
    const arr = JSON.parse(raw);
    if(!Array.isArray(arr)) return [];
    // shape: {ts:number, p10:number, obsTs?:string}
    return arr.filter(x => x && typeof x.ts==="number" && typeof x.p10==="number");
  }catch{ return []; }
}
function saveHistory(arr){
  localStorage.setItem(LS_KEY, JSON.stringify(arr.slice(-5000)));
}
function clearHistory(){
  localStorage.removeItem(LS_KEY);
}

function loadCfg(){
  try{
    const raw = localStorage.getItem(LS_CFG);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch{ return null; }
}
function saveCfg(cfg){
  localStorage.setItem(LS_CFG, JSON.stringify(cfg));
}

// ==========================
// URL builder (real API only)
// ==========================
function buildUrl(apiKey){
  const base = "https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0002-001";
  const params = new URLSearchParams({ Authorization: apiKey || "" });
  return `${base}?${params.toString()}`;
}

// ==========================
// Fetch + parse
// ==========================
async function fetchCwaLatest(apiKey, useMock){
  if(useMock){
    const res = await fetch("./mock_cwa.json", { cache:"no-store" });
    if(!res.ok) throw new Error(`Mock HTTP ${res.status}ï¼ˆè«‹ç¢ºèª mock_cwa.json èˆ‡ index.html åŒå±¤ï¼‰`);
    const json = await res.json();
    const stations = json?.records?.Station;
    if(!Array.isArray(stations)) throw new Error("Mock æ ¼å¼ä¸ç¬¦ï¼šæ‰¾ä¸åˆ° records.Station");
    return stations;
  }

  const url = buildUrl(apiKey);
  const res = await fetch(url, { cache:"no-store" });
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  const json = await res.json();

  const stations = json?.records?.Station;
  if(!Array.isArray(stations)) throw new Error("è³‡æ–™æ ¼å¼ä¸ç¬¦ï¼šæ‰¾ä¸åˆ° records.Station");
  return stations;
}

function pickStation(stations, stationId){
  const sid = (stationId||"").trim();
  if(!sid) return null;

  let s = stations.find(x => (x?.StationId || x?.StationID || "").toString().trim() === sid);
  if(!s){
    const sid2 = sid.toLowerCase();
    s = stations.find(x => ((x?.StationId || x?.StationID || "").toString().trim().toLowerCase() === sid2));
  }
  return s || null;
}

function extractRain10Min(st){
  const v = st?.RainfallElement?.Now?.Precipitation
        ?? st?.RainfallElement?.Now?.Precipitation10Min
        ?? st?.RainfallElement?.Precipitation
        ?? st?.Precipitation;

  if(v === "T" || v === "-" || v === null || v === undefined) return 0.0;
  const num = Number(v);
  if(!Number.isFinite(num) || num < 0) return NaN;
  return num;
}

function extractObsTime(st){
  const t = st?.ObsTime?.DateTime || st?.DateTime || st?.ObsTime;
  return (typeof t === "string" && t) ? t : null;
}

function extractStationName(st){
  return st?.StationName || st?.Station?.StationName || "â€”";
}

// ==========================
// Rain analytics (1h/24h/72h + AER)
// ==========================
function sumWindow(history, windowMs, tNow){
  const t0 = tNow - windowMs;
  let s = 0;
  for(let i = history.length-1; i >= 0; i--){
    const it = history[i];
    if(it.ts < t0) break;
    s += it.p10;
  }
  return s;
}

function computeAER(history, halfLifeH, tNow){
  if(!Number.isFinite(halfLifeH) || halfLifeH <= 0) return NaN;

  const lambda = Math.LN2 / halfLifeH;
  let s = 0;
  for(let i = history.length-1; i >= 0; i--){
    const it = history[i];
    const ageH = (tNow - it.ts) / 3600000;
    if(ageH > 240) break; // 10 å¤©
    s += it.p10 * Math.exp(-lambda * ageH);
  }
  return s;
}

// ==========================
// Risk logic
// ==========================
function classifyRisk({R24, R72, AER, th}){
  if(Number.isFinite(th.aerRed) && Number.isFinite(AER) && AER >= th.aerRed){
    return { level:"ç´…è‰²ï¼ˆAER è§¸ç™¼ï¼‰", color:"--danger" };
  }
  if(R24 >= th.r24_red && R72 >= th.r72_red){
    return { level:"ç´…è‰²ï¼ˆç«‹å³è­¦æˆ’ï¼‰", color:"--danger" };
  }
  if(R24 >= th.r24_orange){
    return { level:"æ©˜è‰²ï¼ˆé«˜åº¦è­¦æˆ’ï¼‰", color:"--warn" };
  }
  if(R24 >= th.r24_yellow){
    return { level:"é»ƒè‰²ï¼ˆæ³¨æ„ï¼‰", color:"--info" };
  }
  return { level:"ç¶ è‰²ï¼ˆæ­£å¸¸ï¼‰", color:"--ok" };
}

// ==========================
// UI rendering
// ==========================
function render(history, metrics){
  $("k10").textContent  = fmt(metrics.p10, 1);
  $("k1h").textContent  = fmt(metrics.R1h, 1);
  $("k24h").textContent = fmt(metrics.R24, 1);
  $("k72h").textContent = fmt(metrics.R72, 1);
  $("kAER").textContent = fmt(metrics.AER, 1);
  $("kN").textContent   = String(history.length);

  $("lastTs").textContent = metrics.lastTs || "â€”";
  $("stName").textContent = metrics.stationName || "â€”";
  $("stId").textContent   = metrics.stationId || "â€”";

  setRisk(metrics.risk.level, metrics.risk.color);

  // Table (latest 12)
  const rows = [];
  const last = history.slice(-12).reverse();
  for(const it of last){
    const t = new Date(it.ts);
    const ts = `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`;
    const subHist = history.filter(x=>x.ts<=it.ts);
    rows.push(`
      <tr>
        <td class="mono">${ts}</td>
        <td class="right mono">${fmt(it.p10, 1)}</td>
        <td class="right mono">${fmt(sumWindow(subHist, 1*3600*1000, it.ts), 1)}</td>
        <td class="right mono">${fmt(sumWindow(subHist, 24*3600*1000, it.ts), 1)}</td>
        <td class="right mono">${fmt(sumWindow(subHist, 72*3600*1000, it.ts), 1)}</td>
      </tr>
    `);
  }
  $("tbody").innerHTML = rows.join("");

  drawChart(history);

  $("debugLine").textContent = `R24=${fmt(metrics.R24,1)} R72=${fmt(metrics.R72,1)} AER=${fmt(metrics.AER,1)}`;
}

function drawChart(history){
  const canvas = $("chart");
  const ctx = canvas.getContext("2d");
  const W = canvas.width, H = canvas.height;

  ctx.clearRect(0,0,W,H);

  ctx.lineWidth = 1;
  ctx.strokeStyle = "rgba(38,49,74,.9)";
  ctx.strokeRect(0.5,0.5,W-1,H-1);

  const tNow = nowMs();
  const t0 = tNow - 24*3600*1000;
  const data = history.filter(x => x.ts >= t0);
  if(data.length < 2){
    ctx.fillStyle = "rgba(169,183,211,.8)";
    ctx.font = "16px ui-sans-serif, system-ui";
    ctx.fillText("è³‡æ–™ä¸è¶³ï¼ˆéœ€ç´¯ç©ä¸€æ®µæ™‚é–“æ‰æœƒæœ‰ 24h åœ–ï¼‰", 16, 40);
    return;
  }

  const maxP = Math.max(...data.map(x => x.p10), 5);
  const padL=50, padR=12, padT=14, padB=26;
  const x0=padL, y0=padT, x1=W-padR, y1=H-padB;

  ctx.strokeStyle = "rgba(38,49,74,.5)";
  ctx.fillStyle = "rgba(169,183,211,.7)";
  ctx.font = "12px ui-monospace, monospace";
  for(let i=0;i<=4;i++){
    const y = y1 - (i/4)*(y1-y0);
    ctx.beginPath(); ctx.moveTo(x0,y); ctx.lineTo(x1,y); ctx.stroke();
    const v = (i/4)*maxP;
    ctx.fillText(v.toFixed(1), 10, y+4);
  }

  const tMin = data[0].ts;
  const tMax = data[data.length-1].ts;

  function X(ts){ return x0 + ( (ts - tMin) / (tMax - tMin || 1) ) * (x1-x0); }
  function Y(p){ return y1 - (p / maxP) * (y1-y0); }

  ctx.strokeStyle = "rgba(96,165,250,.95)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(X(data[0].ts), Y(data[0].p10));
  for(let i=1;i<data.length;i++){
    ctx.lineTo(X(data[i].ts), Y(data[i].p10));
  }
  ctx.stroke();

  ctx.fillStyle = "rgba(169,183,211,.75)";
  const tA = new Date(tMin);
  const tB = new Date(tMax);
  ctx.fillText(`${String(tA.getHours()).padStart(2,"0")}:${String(tA.getMinutes()).padStart(2,"0")}`, x0, H-8);
  ctx.fillText(`${String(tB.getHours()).padStart(2,"0")}:${String(tB.getMinutes()).padStart(2,"0")}`, x1-42, H-8);

  ctx.fillStyle = "rgba(230,238,252,.9)";
  ctx.font = "14px ui-sans-serif, system-ui";
  ctx.fillText("è¿‘ 24 å°æ™‚ï¼šæ¯æ¬¡æŠ“å–çš„ 10 åˆ†é˜é›¨é‡ï¼ˆmmï¼‰", x0, 22);
}

// ==========================
// Main loop
// ==========================
let timer = null;
let lastAlert = null;

function readThresholds(){
  return {
    r24_yellow: Number($("thY_R24").value),
    r24_orange: Number($("thO_R24").value),
    r24_red:    Number($("thR_R24").value),
    r72_red:    Number($("thR_R72").value),
    aerRed:     $("thAER_Red").value.trim()==="" ? NaN : Number($("thAER_Red").value),
  };
}

function readCfgFromUI(){
  const useMock = $("useMock").checked;
  const apiKey = $("apiKey").value.trim();
  const stationId = $("stationId").value.trim();
  const pollSec = Number($("pollSec").value);
  const halfLife = Number($("aerHalfLifeH").value);
  const th = readThresholds();
  return { useMock, apiKey, stationId, pollSec, halfLife, th };
}

function applyCfgToUI(cfg){
  $("useMock").checked = !!cfg.useMock;
  $("apiKey").value = cfg.apiKey || "";
  $("stationId").value = cfg.stationId || "";
  $("pollSec").value = String(cfg.pollSec || 600);
  $("aerHalfLifeH").value = String(cfg.halfLife || 36);
  if(cfg.th){
    $("thY_R24").value = String(cfg.th.r24_yellow ?? 80);
    $("thO_R24").value = String(cfg.th.r24_orange ?? 150);
    $("thR_R24").value = String(cfg.th.r24_red ?? 200);
    $("thR_R72").value = String(cfg.th.r72_red ?? 300);
    $("thAER_Red").value = Number.isFinite(cfg.th.aerRed) ? String(cfg.th.aerRed) : "";
  }
}

function refreshApiPreview(){
  const cfg = readCfgFromUI();
  $("apiUrl").value = cfg.useMock ? "./mock_cwa.json" : buildUrl(cfg.apiKey || "YOUR_KEY");
  $("apiKey").disabled = cfg.useMock; // mock ä¸ç”¨ key
}

async function tick({showToastOnAlert=true}={}){
  const cfg = readCfgFromUI();

  if(!cfg.stationId){
    setSys("è«‹å…ˆå¡« StationId", "--warn");
    return;
  }
  if(!cfg.useMock && !cfg.apiKey){
    setSys("çœŸ API éœ€è¦å¡« API Keyï¼ˆAuthorizationï¼‰", "--warn");
    return;
  }

  refreshApiPreview();

  try{
    setSys("æŠ“å–ä¸­â€¦", "--info");
    const stations = await fetchCwaLatest(cfg.apiKey, cfg.useMock);
    const st = pickStation(stations, cfg.stationId);
    if(!st) throw new Error("æ‰¾ä¸åˆ°è©² StationIdï¼ˆè«‹ç¢ºèªç«™è™Ÿæ˜¯å¦æ­£ç¢ºã€mock å…§æ˜¯å¦æœ‰è©²ç«™ï¼‰");

    let p10 = extractRain10Min(st);
    const obsTs = extractObsTime(st);
    const name = extractStationName(st);

    if(!Number.isFinite(p10)){
      throw new Error("é›¨é‡å€¼ç„¡æ•ˆï¼ˆå¯èƒ½æ˜¯ X/-99 ç­‰ç‰¹æ®Šä»£ç¢¼æˆ–ç«™é»ç„¡è³‡æ–™ï¼‰");
    }

    // âœ… Mock æ¨¡å¼ï¼šè®“æ¯æ¬¡ tick çš„é›¨é‡æ›´åƒçœŸçš„ï¼ˆå°å¹…æ³¢å‹•ã€å¶çˆ¾æš´é›¨ï¼‰
    if(cfg.useMock){
      const bump = (Math.random() < 0.08) ? (10 + Math.random()*15) : (Math.random()*3);
      p10 = Math.round((p10 + bump) * 10) / 10;
    }

    // Update history (dedupe)
    const hist = loadHistory();
    const ts = nowMs();
    if(hist.length>0 && (ts - hist[hist.length-1].ts) < 3*60*1000){
      hist[hist.length-1] = { ts, p10, obsTs };
    }else{
      hist.push({ ts, p10, obsTs });
    }

    // Trim old points
    const keepAfter = ts - 10*24*3600*1000;
    const hist2 = hist.filter(x => x.ts >= keepAfter);
    saveHistory(hist2);

    // Compute metrics
    const R1h  = sumWindow(hist2,  1*3600*1000, ts);
    const R24  = sumWindow(hist2, 24*3600*1000, ts);
    const R72  = sumWindow(hist2, 72*3600*1000, ts);
    const AER  = computeAER(hist2, cfg.halfLife, ts);

    const risk = classifyRisk({R24, R72, AER, th: cfg.th});

    render(hist2, {
      p10, R1h, R24, R72, AER,
      risk,
      lastTs: obsTs || new Date(ts).toISOString(),
      stationName: name,
      stationId: cfg.stationId
    });

    setSys("ç›£æ¸¬ä¸­", "--ok");

    if(showToastOnAlert){
      const key = risk.level;
      const isAlert = key.includes("é»ƒè‰²") || key.includes("æ©˜è‰²") || key.includes("ç´…è‰²");
      if(isAlert && lastAlert !== key){
        const msg = [
          `æ¸¬ç«™ï¼š<b>${name}</b>ï¼ˆ<span class="mono">${cfg.stationId}</span>ï¼‰`,
          `10min=<span class="mono">${fmt(p10,1)}</span>mmã€€1h=<span class="mono">${fmt(R1h,1)}</span>mm`,
          `24h=<span class="mono">${fmt(R24,1)}</span>mmã€€72h=<span class="mono">${fmt(R72,1)}</span>mmã€€AER=<span class="mono">${fmt(AER,1)}</span>mm`,
          `é–€æª»ï¼šé»ƒ R24â‰¥${cfg.th.r24_yellow}ã€æ©˜ R24â‰¥${cfg.th.r24_orange}ã€ç´… R24â‰¥${cfg.th.r24_red} ä¸” R72â‰¥${cfg.th.r72_red}` +
            (Number.isFinite(cfg.th.aerRed) ? `ã€AERç´…â‰¥${cfg.th.aerRed}` : "")
        ].join("<br/>");
        toast(`âš ï¸ ${risk.level}`, msg);
      }
      lastAlert = key;
    }
  }catch(err){
    setSys(`éŒ¯èª¤ï¼š${err?.message || err}`, "--danger");
  }
}

function start(){
  const cfg = readCfgFromUI();
  saveCfg(cfg);

  $("btnStart").disabled = true;
  $("btnStop").disabled = false;

  tick();

  if(timer) clearInterval(timer);
  timer = setInterval(()=>tick(), Math.max(10, cfg.pollSec)*1000);
}

function stop(){
  if(timer) clearInterval(timer);
  timer = null;
  $("btnStart").disabled = false;
  $("btnStop").disabled = true;
  setSys("å·²åœæ­¢", "--warn");
}

// ==========================
// Events
// ==========================
$("btnStart").addEventListener("click", start);
$("btnStop").addEventListener("click", stop);

$("btnClear").addEventListener("click", ()=>{
  if(confirm("ç¢ºå®šè¦æ¸…é™¤æœ¬æ©Ÿé›¨é‡æ­·å²ï¼ˆlocalStorageï¼‰ï¼Ÿ")){
    clearHistory();
    toast("å·²æ¸…é™¤", "æœ¬æ©Ÿæ­·å²å·²æ¸…é™¤ã€‚è«‹é‡æ–°ç´¯ç©ä¸€æ®µæ™‚é–“æ‰æœƒæœ‰ 24h/72h çµ±è¨ˆã€‚");
    const h = [];
    render(h, {
      p10:NaN,R1h:NaN,R24:NaN,R72:NaN,AER:NaN,
      risk:{level:"â€”",color:"--info"},
      lastTs:null, stationName:null, stationId:null
    });
    setSys("å·²æ¸…é™¤", "--warn");
  }
});

$("btnTest").addEventListener("click", async ()=>{
  await tick({showToastOnAlert:false});
});

$("useMock").addEventListener("change", ()=>{
  refreshApiPreview();
  const cfg = readCfgFromUI();
  saveCfg(cfg);
});

// ==========================
// Init
// ==========================
(function init(){
  const cfg = loadCfg();
  if(cfg) applyCfgToUI(cfg);

  // é è¨­çµ¦ä½ ä¸€å€‹ mock å¸¸ç”¨ç«™è™Ÿï¼ˆè‹¥ç©ºï¼‰
  if(!$("stationId").value.trim()){
    $("stationId").value = "C0A9F0";
  }

  refreshApiPreview();

  // render existing history
  const hist = loadHistory();
  const ts = nowMs();
  const halfLife = Number($("aerHalfLifeH").value || 36);
  render(hist, {
    p10:NaN,
    R1h:sumWindow(hist,1*3600*1000,ts),
    R24:sumWindow(hist,24*3600*1000,ts),
    R72:sumWindow(hist,72*3600*1000,ts),
    AER:computeAER(hist, halfLife, ts),
    risk:{level:"â€”",color:"--info"},
    lastTs:null,
    stationName:null,
    stationId:$("stationId").value.trim() || null
  });

  setSys(hist.length ? "å·²è¼‰å…¥æœ¬æ©Ÿæ­·å²ï¼ˆå°šæœªé–‹å§‹è¼ªè©¢ï¼‰" : "å°šæœªé–‹å§‹", "--info");

  // âœ… è‡ªå‹•é–‹å§‹ï¼šåªè¦ StationId æœ‰å€¼ï¼Œä¸”ï¼ˆMock é–‹å•Ÿ æˆ– çœŸ API æœ‰ keyï¼‰
  const c = readCfgFromUI();
  if(c.stationId && (c.useMock || c.apiKey)){
    start();
  }
})();
</script>
</body>
</html>
