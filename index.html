<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>順向坡位移警示（多站雨量監測 Mock）</title>
  <style>
    :root{
      --bg:#0b1220; --card:#121a2b; --text:#e6eefc; --muted:#a9b7d3; --line:#26314a;
      --btn:#2a66ff; --danger:#ff4d4f; --warn:#ffb020; --ok:#22c55e; --info:#60a5fa;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:linear-gradient(180deg,#0b1220 0%,#070c16 100%);
      color:var(--text);
      font-family:system-ui,-apple-system,"Segoe UI","Noto Sans TC","Microsoft JhengHei",Arial
    }
    header{padding:20px 16px 10px;max-width:1100px;margin:0 auto}
    h1{margin:0 0 6px;font-size:20px}
    .sub{color:var(--muted);font-size:13px;line-height:1.5}
    main{
      max-width:1100px;margin:0 auto;padding:12px 16px 28px;
      display:grid;grid-template-columns:390px 1fr;gap:14px
    }
    @media (max-width:980px){main{grid-template-columns:1fr}}
    .card{
      background:rgba(18,26,43,.92);
      border:1px solid rgba(38,49,74,.9);
      border-radius:14px;
      padding:14px;
      box-shadow:0 10px 28px rgba(0,0,0,.22);
    }
    .row{display:flex;gap:10px;align-items:center}
    .row>*{flex:1}
    label{display:block;color:var(--muted);font-size:12px;margin:10px 0 6px}
    input,select{
      width:100%;
      background:#0c1324;
      border:1px solid #24314c;
      color:var(--text);
      border-radius:10px;
      padding:10px;
      font-size:14px;
      outline:none;
    }
    input:focus,select:focus{border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.15)}
    button{
      background:var(--btn);
      border:none;
      color:white;
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.2px;
    }
    button.secondary{background:#273451}
    button.danger{background:var(--danger)}
    button:disabled{opacity:.55;cursor:not-allowed}
    .pill{
      display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;
      border:1px solid #2b395a;background:#0c1324;color:var(--muted);font-size:12px;white-space:nowrap
    }
    .statusDot{width:10px;height:10px;border-radius:50%}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .kpi{border:1px solid #23304b;border-radius:12px;padding:12px;background:#0c1324}
    .kpi .t{color:var(--muted);font-size:12px}
    .kpi .v{font-size:22px;font-weight:950;margin-top:6px}
    .mono{font-family:ui-monospace,Consolas,monospace}
    .small{color:var(--muted);font-size:12px;line-height:1.5}
    .hr{height:1px;background:rgba(38,49,74,.9);margin:12px 0}
    canvas{width:100%;height:260px;background:#0c1324;border:1px solid #23304b;border-radius:12px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid rgba(38,49,74,.6);padding:8px;font-size:13px}
    th{color:var(--muted);text-align:left}
    .right{text-align:right}

    /* ===== Monitoring feel ===== */
    .pulse{animation:pulse 1.1s infinite ease-in-out}
    @keyframes pulse{
      0%{transform:scale(1);opacity:.9}
      50%{transform:scale(1.45);opacity:1}
      100%{transform:scale(1);opacity:.9}
    }
    .flash{animation:flash 280ms ease-in-out}
    @keyframes flash{
      0%{box-shadow:0 0 0 0 rgba(96,165,250,0)}
      30%{box-shadow:0 0 0 6px rgba(96,165,250,.18)}
      100%{box-shadow:0 0 0 0 rgba(96,165,250,0)}
    }
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid #2b395a;background:#0c1324;
      color:var(--muted);font-size:12px;white-space:nowrap
    }
    .progress{
      height:6px;border-radius:999px;overflow:hidden;
      background:rgba(38,49,74,.65);border:1px solid rgba(38,49,74,.9)
    }
    .progress > div{
      height:100%;
      width:0%;
      background:rgba(96,165,250,.95);
      transition:width .25s linear
    }
    .logbox{
      margin-top:10px;
      border:1px solid rgba(38,49,74,.9);
      background:#0c1324;
      border-radius:12px;
      padding:10px;
      max-height:170px;
      overflow:auto;
    }
    .logline{
      font-size:12px;
      color:var(--muted);
      padding:4px 0;
      border-bottom:1px solid rgba(38,49,74,.35);
    }
    .logline:last-child{border-bottom:none}
    .switch{
      display:flex;gap:10px;align-items:center;
      border:1px solid rgba(38,49,74,.9);
      background:#0c1324;border-radius:12px;padding:10px
    }
    .switch input{width:auto}
  </style>
</head>

<body>
<header>
  <h1>順向坡位移警示（雨量監測：多站 Mock）</h1>
  <div class="sub">
    GitHub Pages 靜態版：從 <span class="mono">mock_cwa.json</span> 載入多站雨量。<br/>
    具備監測感：心跳、倒數、進度條、更新閃爍、事件 Log、風險升級提示（可嗶聲）。
  </div>
</header>

<main>
  <!-- LEFT -->
  <section class="card">
    <div class="row" style="justify-content:space-between">
      <div class="pill"><span class="statusDot" id="sysDot" style="background:var(--info)"></span><span id="sysText">尚未開始</span></div>
      <div class="pill mono">localStorage</div>
    </div>

    <label>案場座標（選「最近站」用）</label>
    <div class="grid2">
      <input id="siteLat" type="number" step="0.000001" placeholder="Latitude 例如 25.0330" />
      <input id="siteLon" type="number" step="0.000001" placeholder="Longitude 例如 121.5654" />
    </div>

    <label>站點選擇（自動從 JSON 讀）</label>
    <select id="stationSelect"></select>

    <div class="row" style="margin-top:10px">
      <button class="secondary" id="btnPickMax">自動選：最大雨量</button>
      <button class="secondary" id="btnPickNear">自動選：最近站</button>
    </div>

    <label>輪詢頻率</label>
    <select id="pollSec">
      <option value="10">每 10 秒（Demo）</option>
      <option value="60">每 60 秒（測試）</option>
      <option value="300">每 5 分鐘</option>
      <option value="600" selected>每 10 分鐘（建議）</option>
    </select>

    <label>警戒門檻（mm，示範）</label>
    <div class="grid3">
      <div><div class="small">黃 R24≥</div><input id="thY" type="number" value="80"/></div>
      <div><div class="small">橘 R24≥</div><input id="thO" type="number" value="150"/></div>
      <div><div class="small">紅 R24≥</div><input id="thR" type="number" value="200"/></div>
    </div>

    <label>提示設定</label>
    <div class="switch">
      <input type="checkbox" id="enableBeep" checked />
      <div class="small" style="margin:0">
        風險升級時嗶一聲（手機/部分瀏覽器需先點一次按鈕才允許發聲）
      </div>
    </div>

    <div class="hr"></div>

    <div class="row">
      <button id="btnStart">開始監測</button>
      <button class="secondary" id="btnStop" disabled>停止</button>
      <button class="danger" id="btnClear">清除本機歷史</button>
    </div>

    <div class="small" style="margin-top:10px">
      ✅ 每次 tick：對「所有站」都寫入一筆歷史（更新三站曲線與比較表）。<br/>
      ✅ 若你想快速看監測感，先把輪詢改成「每 10 秒（Demo）」。
    </div>
  </section>

  <!-- RIGHT -->
  <section class="card">
    <div class="row" style="justify-content:space-between">
      <div class="pill"><span class="statusDot" id="riskDot" style="background:var(--ok)"></span><span id="riskText">—</span></div>
      <div class="pill">Rainfall → Risk</div>
    </div>

    <div class="small" style="margin-top:8px">
      目前選站：<span class="mono" id="curStation">—</span>　
      最後更新：<span class="mono" id="lastTs">—</span>
    </div>

    <!-- Monitoring feel widgets -->
    <div class="row" style="margin-top:10px; justify-content:space-between">
      <div class="badge">
        <span class="statusDot" id="hbDot" style="background:var(--ok)"></span>
        <span id="hbText">待命</span>
      </div>
      <div class="badge mono">
        下次更新倒數：<span id="countdown">—</span>
      </div>
    </div>

    <div class="progress" style="margin-top:10px">
      <div id="progBar"></div>
    </div>

    <div class="logbox" id="logBox" aria-label="event log"></div>

    <div class="hr"></div>

    <div class="grid3">
      <div class="kpi"><div class="t">10min（選站）</div><div class="v"><span id="k10">—</span> mm</div></div>
      <div class="kpi"><div class="t">24h（選站）</div><div class="v"><span id="k24">—</span> mm</div></div>
      <div class="kpi"><div class="t">72h（選站）</div><div class="v"><span id="k72">—</span> mm</div></div>
    </div>

    <div class="hr"></div>

    <div class="small">三站曲線（近 24h 的每次 tick 10min 值）</div>
    <canvas id="chart" width="1200" height="300"></canvas>

    <div class="hr"></div>

    <div class="small" style="margin-bottom:8px">三站即時比較（最新一筆 10min 與 24h）</div>
    <table>
      <thead>
        <tr>
          <th>StationId</th>
          <th>站名</th>
          <th class="right">10min</th>
          <th class="right">24h</th>
          <th class="right">距離黃門檻</th>
        </tr>
      </thead>
      <tbody id="cmpBody"></tbody>
    </table>

    <div class="hr"></div>

    <div class="small" style="margin-bottom:8px">選站近 12 筆紀錄（最新在上）</div>
    <table>
      <thead><tr><th>時間</th><th class="right">10min</th></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </section>
</main>

<script>
/* =========================
   Helpers + storage
========================= */
const $ = (id)=>document.getElementById(id);
const LS_CFG  = "monitor_cfg_v2";
const LS_HIST = "monitor_hist_v2"; // { [StationId]: [{ts,p10}] }

let stations = [];
let histMap = {};
let timer = null;

// monitoring feel state
let nextTickAt = null;
let countdownTimer = null;
let lastRiskText = null;

function nowMs(){ return Date.now(); }
function fmt(n,d=1){ return Number.isFinite(n) ? n.toFixed(d) : "—"; }

function loadCfg(){
  try{ return JSON.parse(localStorage.getItem(LS_CFG)||"null"); }catch{ return null; }
}
function saveCfg(cfg){ localStorage.setItem(LS_CFG, JSON.stringify(cfg)); }
function loadHist(){
  try{ return JSON.parse(localStorage.getItem(LS_HIST)||"{}"); }catch{ return {}; }
}
function saveHist(){ localStorage.setItem(LS_HIST, JSON.stringify(histMap)); }

function setSys(text, cssVar){
  $("sysText").textContent = text;
  $("sysDot").style.background = `var(${cssVar})`;
}
function setRisk(text, cssVar){
  $("riskText").textContent = text;
  $("riskDot").style.background = `var(${cssVar})`;
}

function logEvent(msg){
  const box = $("logBox");
  if(!box) return;
  const t = new Date().toLocaleTimeString();
  const div = document.createElement("div");
  div.className = "logline mono";
  div.textContent = `[${t}] ${msg}`;
  box.prepend(div);
  while(box.childElementCount > 20) box.removeChild(box.lastElementChild);
}

function setHeartbeat(running){
  const dot = $("hbDot");
  const text = $("hbText");
  if(!dot || !text) return;
  if(running){
    dot.classList.add("pulse");
    text.textContent = "監測中";
  }else{
    dot.classList.remove("pulse");
    text.textContent = "待命";
  }
}

function updateCountdown(){
  const el = $("countdown");
  const bar = $("progBar");
  const pollMs = Math.max(10, Number($("pollSec").value||600)) * 1000;

  if(!el || !bar) return;

  if(!nextTickAt){
    el.textContent = "—";
    bar.style.width = "0%";
    return;
  }
  const remain = Math.max(0, nextTickAt - Date.now());
  const mm = String(Math.floor(remain/60000)).padStart(2,"0");
  const ss = String(Math.floor((remain%60000)/1000)).padStart(2,"0");
  el.textContent = `${mm}:${ss}`;

  const done = Math.min(1, Math.max(0, 1 - (remain / pollMs)));
  bar.style.width = `${Math.round(done*100)}%`;
}

function flashUpdate(){
  const canvas = $("chart");
  if(!canvas) return;
  canvas.classList.remove("flash");
  void canvas.offsetWidth;
  canvas.classList.add("flash");
}

function beep(){
  if(!$("enableBeep")?.checked) return;
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.type = "sine";
    o.frequency.value = 880;
    g.gain.value = 0.04;
    o.start();
    setTimeout(()=>{ o.stop(); ctx.close(); }, 130);
  }catch{}
}

/* =========================
   Fetch mock json
========================= */
async function fetchStationsFromMock(){
  const res = await fetch("./mock_cwa.json", { cache:"no-store" });
  if(!res.ok) throw new Error(`Mock HTTP ${res.status}：請確認 mock_cwa.json 與 index.html 同層`);
  const json = await res.json();
  const arr = json?.records?.Station;
  if(!Array.isArray(arr)) throw new Error("Mock 格式錯：找不到 records.Station");
  return arr;
}

function getStationId(s){ return String(s.StationId || s.StationID || "").trim(); }
function getStationName(s){ return String(s.StationName || "").trim(); }
function getLat(s){
  const v = s.Latitude ?? s.Lat ?? s?.GeoInfo?.Coordinates?.Latitude;
  const n = Number(v);
  return Number.isFinite(n) ? n : NaN;
}
function getLon(s){
  const v = s.Longitude ?? s.Lon ?? s?.GeoInfo?.Coordinates?.Longitude;
  const n = Number(v);
  return Number.isFinite(n) ? n : NaN;
}
function getP10Base(s){
  const v = s?.RainfallElement?.Now?.Precipitation ?? s?.Precipitation ?? 0;
  const n = Number(v);
  return Number.isFinite(n) && n >= 0 ? n : 0;
}

/* =========================
   Analytics
========================= */
function sumWindow(points, windowMs, tNow){
  const t0 = tNow - windowMs;
  let s = 0;
  for(let i = points.length-1; i>=0; i--){
    const it = points[i];
    if(it.ts < t0) break;
    s += it.p10;
  }
  return s;
}

function classifyByR24(r24){
  const y = Number($("thY").value||80);
  const o = Number($("thO").value||150);
  const r = Number($("thR").value||200);
  if(r24 >= r) return {text:"紅色（嚴重）", color:"--danger"};
  if(r24 >= o) return {text:"橘色（警戒）", color:"--warn"};
  if(r24 >= y) return {text:"黃色（注意）", color:"--info"};
  return {text:"綠色（正常）", color:"--ok"};
}

/* =========================
   UI rendering
========================= */
function populateSelect(){
  const sel = $("stationSelect");
  sel.innerHTML = "";
  for(const s of stations){
    const id = getStationId(s);
    const name = getStationName(s) || id;
    const opt = document.createElement("option");
    opt.value = id;
    opt.textContent = `${id} — ${name}`;
    sel.appendChild(opt);
  }
}

function currentStationId(){ return $("stationSelect").value; }

function ensureHistForAll(){
  for(const s of stations){
    const id = getStationId(s);
    if(!histMap[id]) histMap[id] = [];
  }
}

function renderSelected(){
  const sid = currentStationId();
  const pts = histMap[sid] || [];
  const tNow = nowMs();

  const last = pts.at(-1);
  const p10 = last ? last.p10 : NaN;
  const r24 = sumWindow(pts, 24*3600*1000, tNow);
  const r72 = sumWindow(pts, 72*3600*1000, tNow);

  $("k10").textContent = fmt(p10,1);
  $("k24").textContent = fmt(r24,1);
  $("k72").textContent = fmt(r72,1);

  const st = stations.find(x=>getStationId(x)===sid);
  $("curStation").textContent = st ? `${sid} — ${getStationName(st)}` : sid;

  const risk = classifyByR24(r24);
  setRisk(risk.text, risk.color);

  // risk change log + beep (optional)
  const cur = risk.text;
  if(lastRiskText && cur !== lastRiskText){
    logEvent(`風險變更：${lastRiskText} → ${cur}`);
    beep();
  }
  lastRiskText = cur;

  // last 12 table
  const rows = pts.slice(-12).reverse().map(it=>{
    return `<tr><td class="mono">${new Date(it.ts).toLocaleString()}</td><td class="right mono">${fmt(it.p10,1)}</td></tr>`;
  }).join("");
  $("tbody").innerHTML = rows;
}

function renderCompare(){
  const tNow = nowMs();
  const y = Number($("thY").value||80);

  const rows = stations.map(s=>{
    const id = getStationId(s);
    const name = getStationName(s);
    const pts = histMap[id] || [];
    const last = pts.at(-1);
    const p10 = last ? last.p10 : NaN;
    const r24 = sumWindow(pts, 24*3600*1000, tNow);
    const remain = Math.max(0, y - r24);
    return { id, name, p10, r24, remain };
  }).sort((a,b)=> (b.r24 - a.r24) || (b.p10 - a.p10));

  $("cmpBody").innerHTML = rows.map(r=>`
    <tr>
      <td class="mono">${r.id}</td>
      <td>${r.name}</td>
      <td class="right mono">${fmt(r.p10,1)}</td>
      <td class="right mono">${fmt(r.r24,1)}</td>
      <td class="right mono">${fmt(r.remain,1)} mm</td>
    </tr>
  `).join("");
}

function drawChart(){
  const c = $("chart");
  const ctx = c.getContext("2d");
  const W = c.width, H = c.height;
  ctx.clearRect(0,0,W,H);

  ctx.strokeStyle = "rgba(38,49,74,.9)";
  ctx.lineWidth = 1;
  ctx.strokeRect(0.5,0.5,W-1,H-1);

  const tNow = nowMs();
  const t0 = tNow - 24*3600*1000;

  const series = stations.map(s=>{
    const id = getStationId(s);
    const pts = (histMap[id] || []).filter(p=>p.ts>=t0);
    return { id, name:getStationName(s), pts };
  });

  const allPts = series.flatMap(s=>s.pts);
  if(allPts.length < 2){
    ctx.fillStyle = "rgba(169,183,211,.8)";
    ctx.font = "16px system-ui";
    ctx.fillText("資料不足（至少需要 2 筆以上才會畫出曲線）", 16, 40);
    return;
  }

  const minT = Math.min(...allPts.map(p=>p.ts));
  const maxT = Math.max(...allPts.map(p=>p.ts));
  const maxP = Math.max(...allPts.map(p=>p.p10), 5);

  const padL=56, padR=12, padT=18, padB=30;
  const x0=padL, y0=padT, x1=W-padR, y1=H-padB;

  function X(ts){ return x0 + ((ts-minT)/((maxT-minT)||1))*(x1-x0); }
  function Y(p){ return y1 - (p/maxP)*(y1-y0); }

  // y grid
  ctx.strokeStyle = "rgba(38,49,74,.5)";
  ctx.fillStyle = "rgba(169,183,211,.75)";
  ctx.font = "12px ui-monospace, monospace";
  for(let i=0;i<=4;i++){
    const y = y1 - (i/4)*(y1-y0);
    ctx.beginPath(); ctx.moveTo(x0,y); ctx.lineTo(x1,y); ctx.stroke();
    ctx.fillText(((i/4)*maxP).toFixed(1), 10, y+4);
  }

  const colors = [
    "rgba(96,165,250,.95)",
    "rgba(34,197,94,.95)",
    "rgba(255,176,32,.95)",
    "rgba(255,77,79,.95)"
  ];

  // legend
  ctx.font = "12px system-ui";
  let lx = x0, ly = 16;

  series.forEach((s, idx)=>{
    if(s.pts.length < 2) return;
    const col = colors[idx % colors.length];

    // line
    ctx.strokeStyle = col;
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(X(s.pts[0].ts), Y(s.pts[0].p10));
    for(let i=1;i<s.pts.length;i++) ctx.lineTo(X(s.pts[i].ts), Y(s.pts[i].p10));
    ctx.stroke();

    // legend
    ctx.fillStyle = col;
    ctx.fillRect(lx, ly-8, 12, 3);
    ctx.fillStyle = "rgba(230,238,252,.9)";
    ctx.fillText(`${s.id}`, lx+16, ly-5);
    lx += 90;
  });

  // x labels
  ctx.fillStyle = "rgba(169,183,211,.75)";
  const tA = new Date(minT), tB = new Date(maxT);
  const fmtHM = (d)=> `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
  ctx.fillText(fmtHM(tA), x0, H-10);
  ctx.fillText(fmtHM(tB), x1-46, H-10);

  // title
  ctx.fillStyle = "rgba(230,238,252,.9)";
  ctx.font = "14px system-ui";
  ctx.fillText("近 24 小時：各站每次 tick 的 10min 雨量（mm）", x0, 26);
}

/* =========================
   Auto pick
========================= */
function haversineKm(lat1, lon1, lat2, lon2){
  const R = 6371;
  const toRad = (x)=> x*Math.PI/180;
  const dLat = toRad(lat2-lat1);
  const dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}

function pickMaxRainStation(){
  const tNow = nowMs();
  let best = null;
  for(const s of stations){
    const id = getStationId(s);
    const pts = histMap[id] || [];
    const r24 = sumWindow(pts, 24*3600*1000, tNow);
    const p10 = pts.at(-1)?.p10 ?? -1;
    const key = r24*1000 + p10;
    if(!best || key > best.key) best = { id, key, r24, p10 };
  }
  if(best){
    $("stationSelect").value = best.id;
    logEvent(`自動選站：最大雨量 → ${best.id}（24h=${fmt(best.r24,1)} / 10min=${fmt(best.p10,1)}）`);
  }
}

function pickNearestStation(){
  const lat = Number($("siteLat").value);
  const lon = Number($("siteLon").value);
  if(!Number.isFinite(lat) || !Number.isFinite(lon)){
    alert("請先填案場座標（lat/lon），或改用「最大雨量」自動選站");
    return;
  }
  let best = null;
  for(const s of stations){
    const slat = getLat(s), slon = getLon(s);
    if(!Number.isFinite(slat) || !Number.isFinite(slon)) continue;
    const d = haversineKm(lat, lon, slat, slon);
    if(!best || d < best.d) best = { id:getStationId(s), d };
  }
  if(best){
    $("stationSelect").value = best.id;
    logEvent(`自動選站：最近站 → ${best.id}（距離約 ${best.d.toFixed(2)} km）`);
  }else{
    alert("JSON 裡沒有站點經緯度（Latitude/Longitude），無法算最近站");
  }
}

/* =========================
   Tick (update all stations)
========================= */
async function tick(){
  try{
    setSys("抓取中…","--info");
    const t = nowMs();

    // update all stations (simulate real changes)
    for(const s of stations){
      const id = getStationId(s);
      const base = getP10Base(s);

      // small bumps, occasional heavy rain (10% chance)
      const bump = (Math.random() < 0.10) ? (8 + Math.random()*18) : (Math.random()*3);
      const p10 = Math.round((base + bump) * 10) / 10;

      histMap[id].push({ ts: t, p10 });
      if(histMap[id].length > 900) histMap[id] = histMap[id].slice(-900);
    }

    saveHist();
    $("lastTs").textContent = new Date(t).toLocaleString();

    renderSelected();
    renderCompare();
    drawChart();

    flashUpdate();
    logEvent("更新成功：所有站點寫入一筆資料");
    setSys("監測中","--ok");

  }catch(e){
    setSys(`錯誤：${e?.message || e}`,"--danger");
    logEvent(`錯誤：${e?.message || e}`);
  }
}

/* =========================
   Start/Stop/Clear
========================= */
function start(){
  const pollMs = Math.max(10, Number($("pollSec").value||600)) * 1000;

  // stop old timers
  if(timer) clearInterval(timer);
  if(countdownTimer) clearInterval(countdownTimer);

  // UI
  $("btnStart").disabled = true;
  $("btnStop").disabled = false;

  setHeartbeat(true);
  logEvent(`開始監測（每 ${Math.round(pollMs/1000)} 秒）`);

  // run once
  tick();

  // countdown
  nextTickAt = Date.now() + pollMs;
  updateCountdown();
  countdownTimer = setInterval(updateCountdown, 250);

  // interval
  timer = setInterval(()=>{
    tick();
    nextTickAt = Date.now() + pollMs;
  }, pollMs);

  // save cfg
  saveCfg({
    stationId: currentStationId(),
    pollSec: Number($("pollSec").value)||600,
    siteLat: $("siteLat").value,
    siteLon: $("siteLon").value,
    thY: $("thY").value, thO: $("thO").value, thR: $("thR").value,
    enableBeep: $("enableBeep").checked
  });
}

function stop(){
  if(timer) clearInterval(timer);
  timer = null;

  if(countdownTimer) clearInterval(countdownTimer);
  countdownTimer = null;

  nextTickAt = null;
  updateCountdown();

  $("btnStart").disabled = false;
  $("btnStop").disabled = true;

  setHeartbeat(false);
  setSys("已停止","--warn");
  logEvent("停止監測");
}

function clearAll(){
  if(!confirm("確定清除所有站的本機歷史？")) return;
  histMap = {};
  localStorage.removeItem(LS_HIST);
  ensureHistForAll();
  $("lastTs").textContent = "—";
  lastRiskText = null;
  renderSelected(); renderCompare(); drawChart();
  setSys("已清除","--warn");
  logEvent("已清除本機歷史");
}

/* =========================
   Init
========================= */
async function init(){
  try{
    setSys("載入站點…","--info");
    stations = await fetchStationsFromMock();

    histMap = loadHist();
    ensureHistForAll();
    populateSelect();

    // load cfg
    const cfg = loadCfg();
    if(cfg){
      if(cfg.stationId) $("stationSelect").value = cfg.stationId;
      if(cfg.pollSec) $("pollSec").value = String(cfg.pollSec);
      if(cfg.siteLat!=null) $("siteLat").value = cfg.siteLat;
      if(cfg.siteLon!=null) $("siteLon").value = cfg.siteLon;
      if(cfg.thY!=null) $("thY").value = cfg.thY;
      if(cfg.thO!=null) $("thO").value = cfg.thO;
      if(cfg.thR!=null) $("thR").value = cfg.thR;
      if(cfg.enableBeep!=null) $("enableBeep").checked = !!cfg.enableBeep;
    }

    // events
    $("btnStart").onclick = start;
    $("btnStop").onclick = stop;
    $("btnClear").onclick = clearAll;

    $("btnPickMax").onclick = ()=>{ pickMaxRainStation(); renderSelected(); };
    $("btnPickNear").onclick = ()=>{ pickNearestStation(); renderSelected(); };

    $("stationSelect").onchange = ()=>{
      saveCfg({ ...(loadCfg()||{}), stationId: currentStationId() });
      logEvent(`切換選站：${currentStationId()}`);
      renderSelected();
    };

    ["thY","thO","thR"].forEach(id=>{
      $(id).onchange = ()=>{
        logEvent(`門檻更新：Y=${$("thY").value} O=${$("thO").value} R=${$("thR").value}`);
        renderSelected(); renderCompare();
      };
    });

    $("pollSec").onchange = ()=>{
      logEvent(`輪詢頻率改為：每 ${$("pollSec").value} 秒（需重新按「開始監測」生效）`);
    };

    // initial UI
    $("lastTs").textContent = "—";
    renderSelected();
    renderCompare();
    drawChart();

    setHeartbeat(false);
    setSys("尚未開始","--info");
    logEvent("頁面已就緒");

  }catch(e){
    setSys(`錯誤：${e?.message || e}`,"--danger");
  }
}

init();
</script>
</body>
</html>
